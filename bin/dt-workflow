#!/usr/bin/env bash

# ============================================================================
# DT-WORKFLOW - Unified Workflow Orchestration
# Usage: dt-workflow <workflow> <topic> [OPTIONS]
# 
# Unified command for orchestrating explorationâ†’researchâ†’decision workflows.
# Provides explicit context injection and standardized output formats.
# ============================================================================

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

VERSION="0.2.0"
SCRIPT_NAME=$(basename "$0")
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOLKIT_ROOT="${SCRIPT_DIR%/bin}"

# Source shared libraries
source "$TOOLKIT_ROOT/lib/core/output-utils.sh"

# Initialize colors
dt_setup_colors

# ============================================================================
# CONTEXT GATHERING
# ============================================================================

gather_cursor_rules() {
    local project_dir="${1:-.}"
    local rules_dir="$project_dir/.cursor/rules"
    
    if [ ! -d "$rules_dir" ]; then
        dt_print_debug "No .cursor/rules directory found"
        return 0
    fi
    
    echo "## Cursor Rules (Universal Context)"
    echo ""
    echo "These rules define project standards and must always be followed."
    echo ""
    
    # Find all .mdc files and output their contents
    local rule_files
    rule_files=$(find "$rules_dir" -name "*.mdc" -type f 2>/dev/null | sort)
    
    if [ -z "$rule_files" ]; then
        echo "*No rule files found*"
        return 0
    fi
    
    for rule_file in $rule_files; do
        local filename
        filename=$(basename "$rule_file")
        echo "### $filename"
        echo ""
        echo '```markdown'
        cat "$rule_file"
        echo '```'
        echo ""
    done
}

gather_project_identity() {
    local project_dir="${1:-.}"
    
    echo "## Project Identity (Universal Context)"
    echo ""
    
    # Check for roadmap
    local roadmap_paths=(
        "$project_dir/admin/planning/roadmap.md"
        "$project_dir/docs/roadmap.md"
        "$project_dir/ROADMAP.md"
    )
    
    for roadmap in "${roadmap_paths[@]}"; do
        if [ -f "$roadmap" ]; then
            echo "### Project Roadmap"
            echo ""
            echo "From: \`$roadmap\`"
            echo ""
            echo '```markdown'
            # Output first 100 lines to keep context manageable
            head -100 "$roadmap"
            echo '```'
            echo ""
            break
        fi
    done
    
    # Check for admin README
    local admin_readme="$project_dir/admin/README.md"
    if [ -f "$admin_readme" ]; then
        echo "### Admin Structure"
        echo ""
        echo "From: \`$admin_readme\`"
        echo ""
        echo '```markdown'
        head -80 "$admin_readme"
        echo '```'
        echo ""
    fi
}

gather_workflow_context() {
    local workflow="$1"
    local topic="$2"
    local project_dir="${3:-.}"
    
    echo "## Workflow-Specific Context"
    echo ""
    
    case "$workflow" in
        explore)
            # For exploration: show existing explorations
            local explorations_dir="$project_dir/admin/explorations"
            if [ -d "$explorations_dir" ]; then
                echo "### Existing Explorations"
                echo ""
                echo "From: \`$explorations_dir\`"
                echo ""
                
                # List exploration directories
                local explorations
                explorations=$(find "$explorations_dir" -maxdepth 1 -type d ! -name explorations 2>/dev/null | sort)
                
                if [ -n "$explorations" ]; then
                    echo "| Exploration | Status |"
                    echo "|-------------|--------|"
                    for exp_dir in $explorations; do
                        local exp_name
                        exp_name=$(basename "$exp_dir")
                        local readme="$exp_dir/README.md"
                        local status="Unknown"
                        if [ -f "$readme" ]; then
                            # Extract status from README
                            status=$(grep -o "Status:\*\* [^|]*" "$readme" 2>/dev/null | head -1 | sed 's/Status:\*\* //' || echo "Unknown")
                        fi
                        echo "| $exp_name | $status |"
                    done
                    echo ""
                fi
            fi
            ;;
        research)
            echo "### Research Context"
            echo ""
            echo "*Research-specific context would be gathered here*"
            echo ""
            ;;
        decision)
            echo "### Decision Context"
            echo ""
            echo "*Decision-specific context (existing ADRs, research) would be gathered here*"
            echo ""
            ;;
        *)
            echo "*No workflow-specific context defined for: $workflow*"
            echo ""
            ;;
    esac
}

gather_git_context() {
    local project_dir="${1:-.}"
    
    echo "## Git Context"
    echo ""
    
    # Current branch
    local branch
    branch=$(git -C "$project_dir" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    echo "- **Current Branch:** \`$branch\`"
    
    # Recent commits (last 5)
    echo "- **Recent Commits:**"
    echo ""
    git -C "$project_dir" log --oneline -5 2>/dev/null | while read -r line; do
        echo "  - $line"
    done
    echo ""
}

# ============================================================================
# STRUCTURE GENERATION
# ============================================================================

generate_exploration_structure() {
    local topic="$1"
    local date
    date=$(date +%Y-%m-%d)
    
    echo "## Generated Structure"
    echo ""
    echo "### Files to Create"
    echo ""
    echo "The following files should be created in \`admin/explorations/$topic/\`:"
    echo ""
    
    # README.md (Hub)
    echo "#### README.md (Hub)"
    echo ""
    echo '```markdown'
    cat << EOF
# $topic - Exploration Hub

**Purpose:** [Brief description of what we're exploring]  
**Status:** ðŸ”´ Exploration  
**Created:** $date  
**Last Updated:** $date

---

## ðŸ“‹ Quick Links

- **[Exploration Document](exploration.md)** - Full exploration with theme analysis
- **[Research Topics](research-topics.md)** - Prioritized research questions

---

## ðŸŽ¯ Overview

[What problem are we solving? Why now?]

---

## ðŸ“Š Exploration Summary

### Themes Analyzed

| Theme | Key Finding |
|-------|-------------|
| [Theme 1] | [Finding] |
| [Theme 2] | [Finding] |

### Initial Recommendations

1. [Recommendation 1]
2. [Recommendation 2]

---

## ðŸš€ Next Steps

1. [Next action]
2. [Next action]

---

**Last Updated:** $date
EOF
    echo '```'
    echo ""
    
    # exploration.md
    echo "#### exploration.md (Main Analysis)"
    echo ""
    echo '```markdown'
    cat << EOF
# Exploration: $topic

**Status:** ðŸ”´ Exploration  
**Created:** $date  
**Last Updated:** $date

---

## ðŸŽ¯ What We're Exploring

[Detailed description of the problem/opportunity]

---

## ðŸ” Themes

### Theme 1: [Name]

[Analysis of this theme]

**Connections:**
- [How this relates to other themes]

**Implications:**
- [What this means for the solution]

**Concerns:**
- [Potential issues]

---

### Theme 2: [Name]

[Analysis]

---

## â“ Key Questions

### Question 1: [Question]

**Context:** [Why this matters]

**Sub-questions:**
- [Sub-question 1]
- [Sub-question 2]

---

## ðŸ’¡ Initial Thoughts

[Preliminary analysis and recommendations]

---

## ðŸš€ Next Steps

1. [Next action]
2. [Next action]

---

## ðŸ”— Related

- [Related document 1]
- [Related document 2]

---

**Last Updated:** $date
EOF
    echo '```'
    echo ""
    
    # research-topics.md
    echo "#### research-topics.md (Research Questions)"
    echo ""
    echo '```markdown'
    cat << EOF
# Research Topics - $topic Exploration

**Status:** ðŸ”´ Exploration  
**Created:** $date  
**Last Updated:** $date

---

## ðŸ“‹ Research Topics

### Priority 1: [BLOCKING]

#### Topic 1: [Name]

**Question:** [Research question]

**Context:** [Why this matters]

**Priority:** BLOCKING / HIGH / MEDIUM / LOW  
**Approach:** ðŸ§ª SPIKE FIRST / Research only

**Suggested Approach:**
- [How to investigate]

---

### Priority 2: [HIGH]

#### Topic 2: [Name]

[Details]

---

## ðŸŽ¯ Research Workflow

### Recommended Order

1. [First topics]
2. [Second topics]

---

**Last Updated:** $date
EOF
    echo '```'
    echo ""
}

# ============================================================================
# VALIDATION (L1/L2/L3 Levels)
# ============================================================================

validate_inputs() {
    local workflow="$1"
    local topic="$2"
    local project_dir="${3:-.}"
    local validation_level="${4:-L1}"
    local exit_on_fail="${5:-true}"
    
    # L1: Existence checks (hard fail)
    if [ "$validation_level" = "L1" ] || [ "$validation_level" = "all" ]; then
        # Check project directory exists
        if [ ! -d "$project_dir" ]; then
            dt_print_status "ERROR" "Project directory does not exist: $project_dir"
            echo ""
            echo "ðŸ’¡ Suggestion: Check the path or use --project to specify correct directory"
            if [ "$exit_on_fail" = "true" ]; then
                exit 1
            else
                return 1
            fi
        fi
        
        # Workflow-specific L1 checks
        case "$workflow" in
            research)
                # L1: Check if exploration exists (for --from-explore)
                local exp_dir="$project_dir/admin/explorations/$topic"
                if [ ! -d "$exp_dir" ]; then
                    dt_print_status "ERROR" "Exploration directory not found: $exp_dir"
                    echo ""
                    echo "ðŸ’¡ Suggestion: Run '/explore $topic' first to create the exploration"
                    if [ "$exit_on_fail" = "true" ]; then
                        exit 1
                    else
                        return 1
                    fi
                fi
                ;;
            decision)
                # L1: Check if research exists (for --from-research)
                local research_dir="$project_dir/admin/research/$topic"
                if [ ! -d "$research_dir" ]; then
                    dt_print_status "ERROR" "Research directory not found: $research_dir"
                    echo ""
                    echo "ðŸ’¡ Suggestion: Run '/research $topic --from-explore $topic' first"
                    if [ "$exit_on_fail" = "true" ]; then
                        exit 1
                    else
                        return 1
                    fi
                fi
                ;;
        esac
    fi
    
    # L2: Structure checks (warn, proceed)
    if [ "$validation_level" = "L2" ] || [ "$validation_level" = "all" ]; then
        case "$workflow" in
            research)
                local research_topics="$project_dir/admin/explorations/$topic/research-topics.md"
                if [ -f "$research_topics" ]; then
                    if ! grep -q "## ðŸ“‹ Research Topics" "$research_topics" 2>/dev/null; then
                        dt_print_status "WARNING" "research-topics.md missing expected '## ðŸ“‹ Research Topics' section"
                        echo "   Proceeding anyway, but structure may be incomplete."
                    fi
                fi
                ;;
        esac
    fi
    
    # L3: Content checks (warn, allow continue)
    if [ "$validation_level" = "L3" ] || [ "$validation_level" = "all" ]; then
        case "$workflow" in
            research)
                local research_topics="$project_dir/admin/explorations/$topic/research-topics.md"
                if [ -f "$research_topics" ]; then
                    local topic_count
                    topic_count=$(grep -c "^#### Topic" "$research_topics" 2>/dev/null || echo "0")
                    if [ "$topic_count" -eq 0 ]; then
                        dt_print_status "WARNING" "No research topics found in research-topics.md"
                        echo "   You may want to add topics before conducting research."
                    fi
                fi
                ;;
        esac
    fi
    
    return 0
}

# ============================================================================
# TOKEN COUNT ESTIMATION
# ============================================================================

estimate_tokens() {
    local text="$1"
    # Rough estimation: ~4 characters per token (conservative)
    local char_count
    char_count=$(echo -n "$text" | wc -c | tr -d ' ')
    local token_estimate
    token_estimate=$((char_count / 4))
    echo "$token_estimate"
}

# ============================================================================
# MAIN OUTPUT (Updated with Research Findings)
# ============================================================================

output_for_ai() {
    local workflow="$1"
    local topic="$2"
    local project_dir="${3:-.}"
    
    # Capture output for token counting
    local output_buffer
    output_buffer=$(mktemp)
    
    {
        echo "# dt-workflow Output: $workflow $topic"
        echo ""
        echo "**Mode:** --interactive (Phase 1)"
        echo "**Generated:** $(date +%Y-%m-%d\ %H:%M)"
        echo ""
        echo "---"
        echo ""
        echo "# CONTEXT"
        echo ""
        echo "The following context has been gathered for this workflow."
        echo "This replaces implicit rule loading with explicit context injection."
        echo ""
        echo "**Context Ordering:** Critical rules (START) â†’ Background (MIDDLE) â†’ Task (END)"
        echo ""
        
        # ====================================================================
        # START: Critical Rules (Highest Attention - Research Finding)
        # ====================================================================
        echo "## ðŸ”´ CRITICAL RULES (START - Highest Attention)"
        echo ""
        gather_cursor_rules "$project_dir"
        
        # ====================================================================
        # MIDDLE: Background Context (Lower Attention)
        # ====================================================================
        echo "---"
        echo ""
        echo "## ðŸ“‹ BACKGROUND CONTEXT (MIDDLE)"
        echo ""
        gather_project_identity "$project_dir"
        gather_git_context "$project_dir"
        
        # ====================================================================
        # MIDDLE: Workflow-Specific Context
        # ====================================================================
        gather_workflow_context "$workflow" "$topic" "$project_dir"
        
        # ====================================================================
        # END: Task + Instructions (High Attention - Research Finding)
        # ====================================================================
        echo "---"
        echo ""
        echo "# TASK (END - High Attention)"
        echo ""
        
        case "$workflow" in
            explore)
                echo "Create an exploration for **$topic** using the structure below."
                echo ""
                echo "Fill in the placeholders with thoughtful analysis based on the context provided."
                echo ""
                generate_exploration_structure "$topic"
                ;;
            *)
                echo "Workflow '$workflow' structure generation not yet implemented."
                ;;
        esac
        
        echo "---"
        echo ""
        echo "# INSTRUCTIONS (END - High Attention)"
        echo ""
        echo "1. Review the CONTEXT section above (rules, project identity, existing work)"
        echo "2. Create the files in the TASK section with appropriate content"
        echo "3. After creation, run \`dt-doc-validate\` to check compliance"
        echo ""
        
        # ====================================================================
        # NEXT STEPS (Research Finding: FR-13)
        # ====================================================================
        echo "---"
        echo ""
        echo "# ðŸš€ NEXT STEPS"
        echo ""
        case "$workflow" in
            explore)
                echo "After completing this exploration:"
                echo ""
                echo "1. Review the exploration documents"
                echo "2. Run: \`/research $topic --from-explore $topic\` to conduct research"
                echo "3. Or run: \`dt-workflow research $topic --from-explore $topic --interactive\`"
                ;;
            research)
                echo "After completing research:"
                echo ""
                echo "1. Review research findings in \`admin/research/$topic/\`"
                echo "2. Run: \`/decision $topic --from-research\` to make decisions"
                echo "3. Or run: \`dt-workflow decision $topic --from-research --interactive\`"
                ;;
            decision)
                echo "After making decisions:"
                echo ""
                echo "1. Review ADRs in \`admin/decisions/$topic/\`"
                echo "2. Run: \`/transition-plan --from-adr\` to create feature plan"
                ;;
        esac
        echo ""
        
    } | tee "$output_buffer"
    
    # Calculate and report token count (Research Finding: FR-5)
    local output_content
    output_content=$(cat "$output_buffer")
    local token_count
    token_count=$(estimate_tokens "$output_content")
    
    echo "---"
    echo ""
    echo "**ðŸ“Š Token Estimate:** ~$token_count tokens (well within 100K+ limits)"
    echo ""
    
    rm -f "$output_buffer"
}

# ============================================================================
# HELP AND VERSION
# ============================================================================

show_help() {
    cat << EOF
Usage: $SCRIPT_NAME <workflow> <topic> [OPTIONS]

Unified workflow orchestration for dev-toolkit. Orchestrates the
explorationâ†’researchâ†’decision workflow pipeline with explicit context injection.

Workflows:
    explore           Start an exploration
    research          Conduct research (requires --from-explore)
    decision          Make a decision (requires --from-research)

Arguments:
    workflow          Workflow type (explore, research, decision)
    topic             Topic or feature name

Options:
    --interactive     Output context + structure for interactive AI fill (Phase 1)
    --validate        Validate inputs without generating output (L1/L2/L3 checks)
    --output FILE     Save output to file instead of stdout
    --project PATH    Project directory (default: current directory)
    --help            Show this help message
    --version         Show version information
    --debug           Enable debug output

Examples:
    $SCRIPT_NAME explore my-feature --interactive
    $SCRIPT_NAME explore auth-system --interactive --output context.md
    $SCRIPT_NAME research my-feature --from-explore my-feature --interactive
    $SCRIPT_NAME explore test-topic --validate

EOF
}

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

main() {
    local workflow=""
    local topic=""
    local interactive=false
    local validate_only=false
    local output_file=""
    local project_dir="."
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help
                exit 0
                ;;
            --version|-v)
                show_version
                exit 0
                ;;
            --debug)
                export DT_DEBUG=true
                shift
                ;;
            --interactive|-i)
                interactive=true
                shift
                ;;
            --validate)
                validate_only=true
                shift
                ;;
            --output|-o)
                output_file="$2"
                shift 2
                ;;
            --project|-p)
                project_dir="$2"
                shift 2
                ;;
            -*)
                dt_print_status "ERROR" "Unknown option: $1"
                echo ""
                show_help
                exit 1
                ;;
            *)
                if [ -z "$workflow" ]; then
                    workflow="$1"
                elif [ -z "$topic" ]; then
                    topic="$1"
                else
                    dt_print_status "ERROR" "Unexpected argument: $1"
                    exit 1
                fi
                shift
                ;;
        esac
    done
    
    # Validate required arguments (L1 Validation - Research Finding: REQ-IO-1)
    if [ -z "$workflow" ]; then
        dt_print_status "ERROR" "Workflow type is required"
        echo ""
        echo "ðŸ’¡ Usage: $SCRIPT_NAME <workflow> <topic> --interactive"
        echo ""
        echo "Available workflows:"
        echo "  explore   - Start an exploration"
        echo "  research  - Conduct research (requires --from-explore)"
        echo "  decision  - Make decisions (requires --from-research)"
        echo ""
        echo "Example: $SCRIPT_NAME explore my-feature --interactive"
        exit 1
    fi
    
    if [ -z "$topic" ]; then
        dt_print_status "ERROR" "Topic is required"
        echo ""
        echo "ðŸ’¡ Usage: $SCRIPT_NAME $workflow <topic> --interactive"
        echo ""
        echo "Example: $SCRIPT_NAME $workflow my-feature --interactive"
        exit 1
    fi
    
    # Validate workflow type
    case "$workflow" in
        explore|research|decision)
            # Valid workflows
            ;;
        *)
            dt_print_status "ERROR" "Unknown workflow: $workflow"
            echo ""
            echo "ðŸ’¡ Available workflows: explore, research, decision"
            echo ""
            echo "Example: $SCRIPT_NAME explore $topic --interactive"
            exit 1
            ;;
    esac
    
    # --validate mode: Check inputs only (Research Finding: REQ-IO-5)
    if [ "$validate_only" = true ]; then
        echo "ðŸ” Validating inputs for: $workflow $topic"
        echo ""
        
        # L1: Existence checks
        echo "L1 Validation (Existence - Hard Fail):"
        if validate_inputs "$workflow" "$topic" "$project_dir" "L1" "false"; then
            dt_print_status "SUCCESS" "L1 checks passed"
        else
            dt_print_status "ERROR" "L1 validation failed"
            exit 1
        fi
        echo ""
        
        # L2: Structure checks
        echo "L2 Validation (Structure - Warn):"
        validate_inputs "$workflow" "$topic" "$project_dir" "L2" "false" || true
        echo ""
        
        # L3: Content checks
        echo "L3 Validation (Content - Warn):"
        validate_inputs "$workflow" "$topic" "$project_dir" "L3" "false" || true
        echo ""
        
        dt_print_status "SUCCESS" "Validation complete"
        exit 0
    fi
    
    # Phase 1: Interactive mode required
    if [ "$interactive" != true ]; then
        dt_print_status "ERROR" "Phase 1 requires --interactive mode"
        echo ""
        echo "ðŸ’¡ Usage: $SCRIPT_NAME $workflow $topic --interactive"
        echo ""
        echo "Phase 1 (current): Script outputs context + structure for manual AI fill"
        echo "Phase 3 (future):  Script will invoke AI directly"
        exit 1
    fi
    
    # L1 Validation: Check required inputs exist (Research Finding: REQ-IO-1)
    validate_inputs "$workflow" "$topic" "$project_dir" "L1"
    
    # L2/L3 Validation: Warn on structure/content issues (non-blocking)
    validate_inputs "$workflow" "$topic" "$project_dir" "L2"
    validate_inputs "$workflow" "$topic" "$project_dir" "L3"
    
    # Generate output
    if [ -n "$output_file" ]; then
        output_for_ai "$workflow" "$topic" "$project_dir" > "$output_file"
        dt_print_status "SUCCESS" "Output saved to: $output_file"
        echo ""
        echo "ðŸ’¡ Next: Open $output_file in Cursor and let AI fill the structure"
    else
        output_for_ai "$workflow" "$topic" "$project_dir"
    fi
}

main "$@"
