#!/usr/bin/env bash

# ============================================================================
# DT-WORKFLOW - Unified Workflow Orchestration
# Usage: dt-workflow <workflow> <topic> [OPTIONS]
# 
# Unified command for orchestrating explorationâ†’researchâ†’decision workflows.
# Provides explicit context injection and standardized output formats.
# ============================================================================

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

VERSION="0.2.0"
SCRIPT_NAME=$(basename "$0")
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOLKIT_ROOT="${SCRIPT_DIR%/bin}"

# Source shared libraries
source "$TOOLKIT_ROOT/lib/core/output-utils.sh"
source "$TOOLKIT_ROOT/lib/doc-gen/render.sh"
source "$TOOLKIT_ROOT/lib/doc-gen/templates.sh"

# Initialize colors
dt_setup_colors

# ============================================================================
# CONTEXT GATHERING
# ============================================================================

gather_cursor_rules() {
    # Gather Cursor rules from .cursor/rules directory for context injection
    # Parameters:
    #   $1 - Project directory (default: current directory)
    # Returns: Markdown-formatted rules output, or empty if no rules found
    
    local project_dir="${1:-.}"
    local rules_dir="$project_dir/.cursor/rules"
    
    # Check if rules directory exists (graceful degradation)
    if [ ! -d "$rules_dir" ]; then
        dt_print_debug "No .cursor/rules directory found"
        return 0
    fi
    
    echo "## Cursor Rules (Universal Context)"
    echo ""
    echo "These rules define project standards and must always be followed."
    echo ""
    
    # Find all .mdc files and output their contents (sorted for consistency)
    local rule_files
    rule_files=$(find "$rules_dir" -name "*.mdc" -type f 2>/dev/null | sort)
    
    if [ -z "$rule_files" ]; then
        echo "*No rule files found*"
        return 0
    fi
    
    # Output each rule file in markdown code blocks for clarity
    for rule_file in $rule_files; do
        local filename
        filename=$(basename "$rule_file")
        echo "### $filename"
        echo ""
        echo '```markdown'
        cat "$rule_file"
        echo '```'
        echo ""
    done
}

gather_project_identity() {
    # Gather project identity context (roadmap, admin structure) for context injection
    # Parameters:
    #   $1 - Project directory (default: current directory)
    # Returns: Markdown-formatted project identity output
    # Note: Checks multiple common locations for roadmap files
    
    local project_dir="${1:-.}"
    
    echo "## Project Identity (Universal Context)"
    echo ""
    
    # Check for roadmap in common locations (priority order)
    local roadmap_paths=(
        "$project_dir/admin/planning/roadmap.md"
        "$project_dir/docs/roadmap.md"
        "$project_dir/ROADMAP.md"
    )
    
    for roadmap in "${roadmap_paths[@]}"; do
        if [ -f "$roadmap" ]; then
            echo "### Project Roadmap"
            echo ""
            echo "From: \`$roadmap\`"
            echo ""
            echo '```markdown'
            # Output first 100 lines to keep context manageable (per ADR-002)
            head -100 "$roadmap"
            echo '```'
            echo ""
            break
        fi
    done
    
    # Check for admin README (provides project structure context)
    local admin_readme="$project_dir/admin/README.md"
    if [ -f "$admin_readme" ]; then
        echo "### Admin Structure"
        echo ""
        echo "From: \`$admin_readme\`"
        echo ""
        echo '```markdown'
        # Output first 80 lines (slightly less than roadmap)
        head -80 "$admin_readme"
        echo '```'
        echo ""
    fi
}

gather_workflow_context() {
    local workflow="$1"
    local topic="$2"
    local project_dir="${3:-.}"
    
    echo "## Workflow-Specific Context"
    echo ""
    
    case "$workflow" in
        explore)
            # For exploration: show existing explorations
            local explorations_dir="$project_dir/admin/explorations"
            if [ -d "$explorations_dir" ]; then
                echo "### Existing Explorations"
                echo ""
                echo "From: \`$explorations_dir\`"
                echo ""
                
                # List exploration directories
                local explorations
                explorations=$(find "$explorations_dir" -maxdepth 1 -type d ! -name explorations 2>/dev/null | sort)
                
                if [ -n "$explorations" ]; then
                    echo "| Exploration | Status |"
                    echo "|-------------|--------|"
                    for exp_dir in $explorations; do
                        local exp_name
                        exp_name=$(basename "$exp_dir")
                        local readme="$exp_dir/README.md"
                        local status="Unknown"
                        if [ -f "$readme" ]; then
                            # Extract status from README
                            status=$(grep -o "Status:\*\* [^|]*" "$readme" 2>/dev/null | head -1 | sed 's/Status:\*\* //' || echo "Unknown")
                        fi
                        echo "| $exp_name | $status |"
                    done
                    echo ""
                fi
            fi
            ;;
        research)
            gather_research_context "$topic" "$project_dir"
            ;;
        decision)
            gather_decision_context "$topic" "$project_dir"
            ;;
        *)
            echo "*No workflow-specific context defined for: $workflow*"
            echo ""
            ;;
    esac
}

gather_research_context() {
    local topic="$1"
    local project_dir="${2:-.}"
    
    echo "### Research Context"
    echo ""
    
    # Check for exploration (upstream)
    local exp_dir="$project_dir/admin/explorations/$topic"
    if [ -d "$exp_dir" ]; then
        echo "#### Related Exploration"
        echo ""
        
        if [ -f "$exp_dir/exploration.md" ]; then
            echo "**Exploration Document:** \`exploration.md\`"
            echo ""
            echo '```markdown'
            # Limit to first 100 lines to avoid token bloat
            head -100 "$exp_dir/exploration.md"
            echo '```'
            echo ""
        fi
        
        # Include handoff file (research-topics.md)
        if [ -f "$exp_dir/research-topics.md" ]; then
            echo "#### Research Topics (from exploration)"
            echo ""
            echo "**Source:** \`research-topics.md\`"
            echo ""
            cat "$exp_dir/research-topics.md"
            echo ""
        fi
    else
        dt_print_debug "Exploration directory not found: $exp_dir"
    fi
    
    # Check for existing research
    local research_dir="$project_dir/admin/research/$topic"
    if [ -d "$research_dir" ]; then
        echo "#### Existing Research"
        echo ""
        
        local research_files
        research_files=$(find "$research_dir" -maxdepth 1 -name "*.md" -type f 2>/dev/null | sort)
        
        if [ -n "$research_files" ]; then
            local file_count
            file_count=$(echo "$research_files" | wc -l | tr -d ' ')
            
            if [ "$file_count" -le 5 ]; then
                # List all files if 5 or fewer
                echo "$research_files" | while read -r f; do
                    echo "- \`$(basename "$f")\`"
                done
            else
                # Show summary if more than 5 files
                echo "**Found $file_count research documents:**"
                echo ""
                echo "$research_files" | head -5 | while read -r f; do
                    echo "- \`$(basename "$f")\`"
                done
                echo "- ... and $((file_count - 5)) more"
            fi
            echo ""
        else
            dt_print_debug "No existing research documents found in: $research_dir"
        fi
    else
        dt_print_debug "Research directory not found: $research_dir (will be created)"
    fi
}

gather_decision_context() {
    local topic="$1"
    local project_dir="${2:-.}"
    
    echo "### Decision Context"
    echo ""
    
    # Check for research (upstream)
    local research_dir="$project_dir/admin/research/$topic"
    if [ -d "$research_dir" ]; then
        echo "#### Research Summary (from research workflow)"
        echo ""
        
        if [ -f "$research_dir/research-summary.md" ]; then
            echo "**Source:** \`research-summary.md\` (handoff file per Pattern 4)"
            echo ""
            echo '```markdown'
            # Limit to first 150 lines to avoid token bloat
            head -150 "$research_dir/research-summary.md"
            echo '```'
            echo ""
        else
            dt_print_debug "Research summary not found: $research_dir/research-summary.md"
        fi
        
        # Include requirements if exists
        if [ -f "$research_dir/requirements.md" ]; then
            echo "#### Requirements"
            echo ""
            echo "**Source:** \`requirements.md\`"
            echo ""
            cat "$research_dir/requirements.md"
            echo ""
        else
            dt_print_debug "Requirements file not found: $research_dir/requirements.md"
        fi
    else
        dt_print_debug "Research directory not found: $research_dir"
    fi
    
    # Check for existing decisions
    local decisions_dir="$project_dir/admin/decisions/$topic"
    if [ -d "$decisions_dir" ]; then
        echo "#### Existing ADRs"
        echo ""
        
        local adr_files
        adr_files=$(find "$decisions_dir" -maxdepth 1 -name "adr-*.md" -type f 2>/dev/null | sort)
        
        if [ -n "$adr_files" ]; then
            local adr_count
            adr_count=$(echo "$adr_files" | wc -l | tr -d ' ')
            
            if [ "$adr_count" -le 5 ]; then
                # List all ADRs if 5 or fewer
                echo "$adr_files" | while read -r f; do
                    echo "- \`$(basename "$f")\`"
                done
            else
                # Show summary if more than 5 ADRs
                echo "**Found $adr_count ADRs:**"
                echo ""
                echo "$adr_files" | head -5 | while read -r f; do
                    echo "- \`$(basename "$f")\`"
                done
                echo "- ... and $((adr_count - 5)) more"
            fi
            echo ""
        else
            dt_print_debug "No existing ADRs found in: $decisions_dir"
        fi
    else
        dt_print_debug "Decisions directory not found: $decisions_dir (will be created)"
    fi
}

gather_git_context() {
    local project_dir="${1:-.}"
    
    echo "## Git Context"
    echo ""
    
    # Current branch
    local branch
    branch=$(git -C "$project_dir" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    echo "- **Current Branch:** \`$branch\`"
    
    # Recent commits (last 5)
    echo "- **Recent Commits:**"
    echo ""
    git -C "$project_dir" log --oneline -5 2>/dev/null | while read -r line; do
        echo "  - $line"
    done
    echo ""
}

# ============================================================================
# STRUCTURE GENERATION
# ============================================================================

generate_exploration_structure() {
    local topic="$1"
    
    # Find templates directory
    local templates_root
    templates_root=$(dt_find_templates) || {
        dt_print_status "ERROR" "Templates not found - templates are required for structure generation"
        dt_print_debug "Template search failed - templates must be available"
        echo ""
        echo "ðŸ’¡ Suggestion: Ensure dev-infra templates are installed or DT_TEMPLATES_PATH is set"
        echo ""
        echo "Expected locations:"
        echo "  - \$HOME/Projects/dev-infra/scripts/doc-gen/templates"
        echo "  - \$HOME/dev-infra/scripts/doc-gen/templates"
        echo "  - Or set DT_TEMPLATES_PATH environment variable"
        return 1
    }
    
    dt_print_debug "Using templates from: $templates_root"
    
    # Set template variables
    dt_set_exploration_vars "$topic" "Exploration of $topic"
    dt_print_debug "Set exploration variables for topic: $topic"
    
    echo "## Generated Structure"
    echo ""
    echo "### Files to Create"
    echo ""
    echo "The following files should be created in \`admin/explorations/$topic/\`:"
    echo ""
    
    # Render exploration.md template
    local exploration_template
    exploration_template=$(dt_get_template_path "exploration" "exploration" "$templates_root")
    dt_print_debug "Exploration template path: $exploration_template"
    
    if [ -f "$exploration_template" ]; then
        echo "#### exploration.md (Main Analysis)"
        echo ""
        echo '```markdown'
        local temp_output
        temp_output=$(mktemp)
        if dt_render_template "$exploration_template" "$temp_output" "exploration" 2>/dev/null; then
            cat "$temp_output"
            dt_print_debug "Successfully rendered exploration template"
        else
            # Template rendering failed - templates are required
            dt_print_status "ERROR" "Template rendering failed for: $exploration_template"
            dt_print_debug "Template rendering failed - check template file and variables"
            rm -f "$temp_output"
            return 1
        fi
        rm -f "$temp_output"
        echo '```'
        echo ""
    else
        dt_print_status "ERROR" "Exploration template not found: $exploration_template"
        dt_print_debug "Template file missing: $exploration_template"
        echo ""
        echo "ðŸ’¡ Suggestion: Ensure dev-infra templates are properly installed"
        return 1
    fi
    
    # Render research-topics.md template
    local research_topics_template
    research_topics_template=$(dt_get_template_path "research_topics" "research_topics" "$templates_root")
    dt_print_debug "Research topics template path: $research_topics_template"
    
    if [ -f "$research_topics_template" ]; then
        echo "#### research-topics.md (Research Questions)"
        echo ""
        echo '```markdown'
        local temp_output2
        temp_output2=$(mktemp)
        if dt_render_template "$research_topics_template" "$temp_output2" "research_topics" 2>/dev/null; then
            cat "$temp_output2"
            dt_print_debug "Successfully rendered research-topics template"
        else
            dt_print_debug "Research-topics template rendering failed, using minimal output"
            echo "# Research Topics - ${TOPIC_TITLE} Exploration"
            echo ""
            echo "**Status:** ${STATUS}"
            echo "**Created:** ${DATE}"
            echo "**Last Updated:** ${DATE}"
        fi
        rm -f "$temp_output2"
        echo '```'
        echo ""
    else
        dt_print_debug "Research-topics template not found: $research_topics_template (skipping)"
    fi
    
    # Render exploration hub (README.md) template
    local hub_template
    hub_template=$(dt_get_template_path "exploration_hub" "exploration_hub" "$templates_root")
    dt_print_debug "Exploration hub template path: $hub_template"
    
    if [ -f "$hub_template" ]; then
        echo "#### README.md (Hub)"
        echo ""
        echo '```markdown'
        local temp_output3
        temp_output3=$(mktemp)
        if dt_render_template "$hub_template" "$temp_output3" "exploration_hub" 2>/dev/null; then
            cat "$temp_output3"
            dt_print_debug "Successfully rendered exploration hub template"
        else
            dt_print_debug "Exploration hub template rendering failed (skipping)"
        fi
        rm -f "$temp_output3"
        echo '```'
        echo ""
    else
        dt_print_debug "Exploration hub template not found: $hub_template (skipping)"
    fi
}

generate_research_structure() {
    local topic="$1"
    
    # Find templates directory
    local templates_root
    templates_root=$(dt_find_templates) || {
        dt_print_status "ERROR" "Templates not found - templates are required for structure generation"
        dt_print_debug "Template search failed - templates must be available"
        echo ""
        echo "ðŸ’¡ Suggestion: Ensure dev-infra templates are installed or DT_TEMPLATES_PATH is set"
        echo ""
        echo "Expected locations:"
        echo "  - \$HOME/Projects/dev-infra/scripts/doc-gen/templates"
        echo "  - \$HOME/dev-infra/scripts/doc-gen/templates"
        echo "  - Or set DT_TEMPLATES_PATH environment variable"
        return 1
    }
    
    dt_print_debug "Using templates from: $templates_root"
    
    # Set template variables
    dt_set_research_vars "$topic" "" "Research for $topic"
    dt_print_debug "Set research variables for topic: $topic"
    
    echo "## Generated Structure"
    echo ""
    echo "### Files to Create"
    echo ""
    echo "The following files should be created in \`admin/research/$topic/\`:"
    echo ""
    
    # Render research-topic.md template
    local research_template
    research_template=$(dt_get_template_path "research_topic" "research_topic" "$templates_root")
    dt_print_debug "Research template path: $research_template"
    
    if [ -f "$research_template" ]; then
        echo "#### research-topic.md (Main Research Document)"
        echo ""
        echo '```markdown'
        local temp_output
        temp_output=$(mktemp)
        if dt_render_template "$research_template" "$temp_output" "research_topic" 2>/dev/null; then
            cat "$temp_output"
            dt_print_debug "Successfully rendered research template"
        else
            # Template rendering failed - templates are required
            dt_print_status "ERROR" "Template rendering failed for: $research_template"
            dt_print_debug "Template rendering failed - check template file and variables"
            rm -f "$temp_output"
            return 1
        fi
        rm -f "$temp_output"
        echo '```'
        echo ""
    else
        dt_print_status "ERROR" "Research template not found: $research_template"
        dt_print_debug "Template file missing: $research_template"
        echo ""
        echo "ðŸ’¡ Suggestion: Ensure dev-infra templates are properly installed"
        return 1
    fi
    
    # Handoff file guidance per Pattern 4 (FR-10)
    # Reference: docs/patterns/workflow-patterns.md (Pattern 4: Handoff File Contract)
    echo "#### research-summary.md (Handoff File)"
    echo ""
    echo "**Purpose:** Standardized handoff file for researchâ†’decision transition per Pattern 4"
    echo ""
    echo "**Reference:** [Pattern 4: Handoff File Contract](../../docs/patterns/workflow-patterns.md#pattern-4-handoff-file-contract)"
    echo ""
    echo "After completing research, create \`research-summary.md\` with the following required sections:"
    echo ""
    echo '```markdown'
    cat << 'HANDOFF_EOF'
## ðŸ” Key Findings

<!-- AI: Summarize key findings from research with sources -->

### Finding 1: [Title]
[Summary with source references]

---

## ðŸ’¡ Recommendations

<!-- AI: Provide actionable recommendations based on findings -->

1. [Recommendation 1]
2. [Recommendation 2]

---

## ðŸ“Š Requirements Discovered

<!-- AI: List any new requirements discovered during research (FR-*, NFR-*) -->

- [ ] FR-XX: [Requirement description]
- [ ] NFR-XX: [Non-functional requirement]

---

## ðŸš€ Next Steps

1. Review research findings and recommendations above
2. Run `/decision topic --from-research` to make decisions
3. Or run: `dt-workflow decision topic --from-research --interactive`
HANDOFF_EOF
    echo '```'
    echo ""
}

generate_decision_structure() {
    local topic="$1"
    local project_dir="${2:-.}"
    
    # Find templates directory
    local templates_root
    templates_root=$(dt_find_templates) || {
        dt_print_status "ERROR" "Templates not found - templates are required for structure generation"
        dt_print_debug "Template search failed - templates must be available"
        echo ""
        echo "ðŸ’¡ Suggestion: Ensure dev-infra templates are installed or DT_TEMPLATES_PATH is set"
        echo ""
        echo "Expected locations:"
        echo "  - \$HOME/Projects/dev-infra/scripts/doc-gen/templates"
        echo "  - \$HOME/dev-infra/scripts/doc-gen/templates"
        echo "  - Or set DT_TEMPLATES_PATH environment variable"
        return 1
    }
    
    dt_print_debug "Using templates from: $templates_root"
    
    # Auto-detect ADR number from existing ADRs (or default to 001)
    local adr_number="001"
    local decisions_dir="$project_dir/admin/decisions/$topic"
    if [ -d "$decisions_dir" ]; then
        local existing_adrs
        existing_adrs=$(find "$decisions_dir" -name "adr-*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
        if [ "$existing_adrs" -gt 0 ]; then
            # Increment: find highest ADR number and add 1
            local highest_adr
            highest_adr=$(find "$decisions_dir" -name "adr-*.md" -type f 2>/dev/null | sed 's/.*adr-\([0-9]*\)\.md/\1/' | sort -n | tail -1)
            if [ -n "$highest_adr" ]; then
                adr_number=$(printf "%03d" $((highest_adr + 1)))
            fi
        fi
    fi
    
    # Set template variables
    dt_set_decision_vars "$topic" "$adr_number" "Decision for $topic" "Decisions for $topic"
    dt_print_debug "Set decision variables for topic: $topic, ADR: $adr_number"
    
    echo "## Generated Structure"
    echo ""
    echo "### Files to Create"
    echo ""
    echo "The following files should be created in \`admin/decisions/$topic/\`:"
    echo ""
    
    # Render adr.md template
    local adr_template
    adr_template=$(dt_get_template_path "adr" "adr" "$templates_root")
    dt_print_debug "ADR template path: $adr_template"
    
    if [ -f "$adr_template" ]; then
        echo "#### adr-${adr_number}.md (Architectural Decision Record)"
        echo ""
        echo '```markdown'
        local temp_output
        temp_output=$(mktemp)
        if dt_render_template "$adr_template" "$temp_output" "adr" 2>/dev/null; then
            cat "$temp_output"
            dt_print_debug "Successfully rendered ADR template"
        else
            # Template rendering failed - templates are required
            dt_print_status "ERROR" "Template rendering failed for: $adr_template"
            dt_print_debug "Template rendering failed - check template file and variables"
            rm -f "$temp_output"
            return 1
        fi
        rm -f "$temp_output"
        echo '```'
        echo ""
        echo "---"
        echo ""
        echo "## ðŸ“‹ Handoff: decisions-summary.md"
        echo ""
        echo "<!-- AI: After making decisions, update decisions-summary.md with: -->"
        echo ""
        echo "### Required Sections"
        echo ""
        echo "- \`## Decisions\` table with ADR numbers and status"
        echo "- \`## Impact Summary\` - Key consequences"
        echo ""
        echo "**Reference:** See [Pattern 4: Handoff File Contract](../../docs/patterns/workflow-patterns.md#pattern-4-handoff-file-contract) for details."
        echo ""
    else
        dt_print_status "ERROR" "ADR template not found: $adr_template"
        dt_print_debug "Template file missing: $adr_template"
        echo ""
        echo "ðŸ’¡ Suggestion: Ensure dev-infra templates are properly installed"
        return 1
    fi
}

# ============================================================================
# VALIDATION (L1/L2/L3 Levels)
# ============================================================================

validate_inputs() {
    # Validate workflow inputs using tiered validation levels (L1/L2/L3)
    # Parameters:
    #   $1 - Workflow type (explore, research, decision)
    #   $2 - Topic name
    #   $3 - Project directory (default: current directory)
    #   $4 - Validation level: L1 (existence), L2 (structure), L3 (content), or "all"
    #   $5 - Exit on failure: "true" (exit 1) or "false" (return 1)
    # Returns: 0 on success, 1 on failure (if exit_on_fail=false)
    #
    # Validation Levels:
    # - L1: Existence checks (hard fail) - Required directories/files must exist
    # - L2: Structure checks (warn, proceed) - Expected sections/format may be missing
    # - L3: Content checks (warn, allow continue) - Content quality/completeness warnings
    # This tiered approach allows graceful degradation while catching critical issues early.
    
    local workflow="$1"
    local topic="$2"
    local project_dir="${3:-.}"
    local validation_level="${4:-L1}"
    local exit_on_fail="${5:-true}"
    
    # L1: Existence checks (hard fail) - Block execution if prerequisites missing
    if [ "$validation_level" = "L1" ] || [ "$validation_level" = "all" ]; then
        # Check project directory exists
        if [ ! -d "$project_dir" ]; then
            dt_print_status "ERROR" "Error: Project directory does not exist: $project_dir"
            echo ""
            echo "ðŸ’¡ Suggestion: Check the path or use --project to specify correct directory"
            if [ "$exit_on_fail" = "true" ]; then
                exit 1
            else
                return 1
            fi
        fi
        
        # Workflow-specific L1 checks
        case "$workflow" in
            research)
                # L1: Check if exploration exists (for --from-explore)
                local exp_dir="$project_dir/admin/explorations/$topic"
                if [ ! -d "$exp_dir" ]; then
                    dt_print_status "ERROR" "Error: Exploration directory not found: $exp_dir"
                    echo ""
                    echo "ðŸ’¡ Suggestion: Run '/explore $topic' first to create the exploration"
                    if [ "$exit_on_fail" = "true" ]; then
                        exit 1
                    else
                        return 1
                    fi
                fi
                ;;
            decision)
                # L1: Check if research exists (for --from-research)
                local research_dir="$project_dir/admin/research/$topic"
                if [ ! -d "$research_dir" ]; then
                    dt_print_status "ERROR" "Error: Research directory not found: $research_dir"
                    echo ""
                    echo "ðŸ’¡ Suggestion: Run '/research $topic --from-explore $topic' first"
                    if [ "$exit_on_fail" = "true" ]; then
                        exit 1
                    else
                        return 1
                    fi
                fi
                ;;
        esac
    fi
    
    # L2: Structure checks (warn, proceed) - Missing expected sections but can continue
    if [ "$validation_level" = "L2" ] || [ "$validation_level" = "all" ]; then
        case "$workflow" in
            research)
                local research_topics="$project_dir/admin/explorations/$topic/research-topics.md"
                if [ -f "$research_topics" ]; then
                    if ! grep -q "## ðŸ“‹ Research Topics" "$research_topics" 2>/dev/null; then
                        dt_print_status "WARNING" "research-topics.md missing expected '## ðŸ“‹ Research Topics' section"
                        echo "   Proceeding anyway, but structure may be incomplete."
                    fi
                fi
                ;;
        esac
    fi
    
    # L3: Content checks (warn, allow continue) - Quality/completeness warnings only
    if [ "$validation_level" = "L3" ] || [ "$validation_level" = "all" ]; then
        case "$workflow" in
            research)
                local research_topics="$project_dir/admin/explorations/$topic/research-topics.md"
                if [ -f "$research_topics" ]; then
                    local topic_count
                    topic_count=$(grep -c "^#### Topic" "$research_topics" 2>/dev/null || echo "0")
                    if [ "$topic_count" -eq 0 ]; then
                        dt_print_status "WARNING" "No research topics found in research-topics.md"
                        echo "   You may want to add topics before conducting research."
                    fi
                fi
                ;;
        esac
    fi
    
    return 0
}

# ============================================================================
# TOKEN COUNT ESTIMATION
# ============================================================================

estimate_tokens() {
    # Estimate token count for text (used for context size reporting)
    # Parameters:
    #   $1 - Text to estimate
    # Returns: Estimated token count (integer)
    # Note: Uses conservative 4 chars/token ratio (actual is ~3.5-4.5 depending on content)
    
    local text="$1"
    # Rough estimation: ~4 characters per token (conservative estimate)
    local char_count
    char_count=$(echo -n "$text" | wc -c | tr -d ' ')
    local token_estimate
    token_estimate=$((char_count / 4))
    echo "$token_estimate"
}

# ============================================================================
# OUTPUT GENERATION
# ============================================================================

output_for_ai() {
    # Generate formatted output for AI consumption with explicit context injection
    # Parameters:
    #   $1 - Workflow type (explore, research, decision)
    #   $2 - Topic name
    #   $3 - Project directory (default: current directory)
    # Returns: Markdown-formatted output with context and task structure
    # 
    # Context Ordering Rationale (per ADR-002):
    # - START: Critical rules (highest attention) - AI must follow these
    # - MIDDLE: Background context (lower attention) - Reference material
    # - END: Task + Instructions (high attention) - What AI should do
    # This ordering addresses "lost in middle" problem where important info
    # placed in middle gets less attention from LLMs.
    
    local workflow="$1"
    local topic="$2"
    local project_dir="${3:-.}"
    
    # Capture output for token counting (Research Finding: FR-5)
    local output_buffer
    output_buffer=$(mktemp)
    
    {
        echo "# dt-workflow Output: $workflow $topic"
        echo ""
        echo "**Mode:** --interactive (Phase 1)"
        echo "**Generated:** $(date +%Y-%m-%d\ %H:%M)"
        echo ""
        echo "---"
        echo ""
        echo "# CONTEXT"
        echo ""
        echo "The following context has been gathered for this workflow."
        echo "This replaces implicit rule loading with explicit context injection."
        echo ""
        echo "**Context Ordering:** Critical rules (START) â†’ Background (MIDDLE) â†’ Task (END)"
        echo ""
        
        # ====================================================================
        # START: Critical Rules (Highest Attention - Research Finding)
        # Placed at START to ensure maximum AI attention (ADR-002)
        # ====================================================================
        echo "## ðŸ”´ CRITICAL RULES (START - Highest Attention)"
        echo ""
        gather_cursor_rules "$project_dir"
        
        # ====================================================================
        # MIDDLE: Background Context (Lower Attention)
        # ====================================================================
        echo "---"
        echo ""
        echo "## ðŸ“‹ BACKGROUND CONTEXT (MIDDLE)"
        echo ""
        gather_project_identity "$project_dir"
        gather_git_context "$project_dir"
        
        # ====================================================================
        # MIDDLE: Workflow-Specific Context
        # ====================================================================
        gather_workflow_context "$workflow" "$topic" "$project_dir"
        
        # ====================================================================
        # END: Task + Instructions (High Attention - Research Finding)
        # ====================================================================
        echo "---"
        echo ""
        echo "# TASK (END - High Attention)"
        echo ""
        
        case "$workflow" in
            explore)
                echo "Create an exploration for **$topic** using the structure below."
                echo ""
                echo "Fill in the placeholders with thoughtful analysis based on the context provided."
                echo ""
                generate_exploration_structure "$topic"
                ;;
            research)
                echo "Create a research document for **$topic** using the structure below."
                echo ""
                echo "Fill in the placeholders with thoughtful analysis based on the context provided."
                echo ""
                generate_research_structure "$topic"
                ;;
            decision)
                echo "Create a decision document (ADR) for **$topic** using the structure below."
                echo ""
                echo "Fill in the placeholders with thoughtful analysis based on the context provided."
                echo ""
                generate_decision_structure "$topic" "$project_dir"
                ;;
            *)
                echo "Workflow '$workflow' structure generation not yet implemented."
                ;;
        esac
        
        echo "---"
        echo ""
        echo "# INSTRUCTIONS (END - High Attention)"
        echo ""
        echo "1. Review the CONTEXT section above (rules, project identity, existing work)"
        echo "2. Create the files in the TASK section with appropriate content"
        echo "3. After creation, run \`dt-doc-validate\` to check compliance"
        echo ""
        
        # ====================================================================
        # NEXT STEPS (Research Finding: FR-13)
        # ====================================================================
        echo "---"
        echo ""
        echo "# ðŸš€ NEXT STEPS"
        echo ""
        case "$workflow" in
            explore)
                echo "After completing this exploration:"
                echo ""
                echo "1. Review the exploration documents"
                echo "2. Run: \`/research $topic --from-explore $topic\` to conduct research"
                echo "3. Or run: \`dt-workflow research $topic --from-explore $topic --interactive\`"
                ;;
            research)
                echo "After completing research:"
                echo ""
                echo "1. Review research findings in \`admin/research/$topic/\`"
                echo "2. Create \`research-summary.md\` with key findings and recommendations (handoff file per Pattern 4)"
                echo "3. Run: \`/decision $topic --from-research\` to make decisions"
                echo "4. Or run: \`dt-workflow decision $topic --from-research --interactive\`"
                ;;
            decision)
                echo "After making decisions:"
                echo ""
                echo "1. Complete ADR with all sections (Context, Decision, Consequences, Alternatives Considered)"
                echo "2. Update \`decisions-summary.md\` with new ADR (handoff file per Pattern 4)"
                echo "3. Run: \`/transition-plan --from-adr $topic\` to create implementation plan"
                echo "4. Or run: \`dt-workflow transition-plan --from-adr $topic --interactive\`"
                ;;
        esac
        echo ""
        
    } | tee "$output_buffer"
    
    # Calculate and report token count (Research Finding: FR-5)
    local output_content
    output_content=$(cat "$output_buffer")
    local token_count
    token_count=$(estimate_tokens "$output_content")
    
    echo "---"
    echo ""
    echo "**ðŸ“Š Token Estimate:** ~$token_count tokens (well within 100K+ limits)"
    echo ""
    
    rm -f "$output_buffer"
}

# ============================================================================
# HELP AND VERSION
# ============================================================================

show_help() {
    cat << EOF
Usage: $SCRIPT_NAME <workflow> <topic> [OPTIONS]

Unified workflow orchestration for dev-toolkit. Orchestrates the
explorationâ†’researchâ†’decision workflow pipeline with explicit context injection.

Workflows:
    explore           Start an exploration
    research          Conduct research (requires --from-explore)
    decision          Make a decision (requires --from-research)

Arguments:
    workflow          Workflow type (explore, research, decision)
    topic             Topic or feature name

Options:
    --interactive     Output context + structure for interactive AI fill (Phase 1)
    --validate        Validate inputs without generating output (L1/L2/L3 checks)
    --output FILE     Save output to file instead of stdout
    --project PATH    Project directory (default: current directory)
    --help            Show this help message
    --version         Show version information
    --debug           Enable debug output

Examples:
    $SCRIPT_NAME explore my-feature --interactive
    $SCRIPT_NAME explore auth-system --interactive --output context.md
    $SCRIPT_NAME research my-feature --from-explore my-feature --interactive
    $SCRIPT_NAME explore test-topic --validate

EOF
}

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

main() {
    local workflow=""
    local topic=""
    local interactive=false
    local validate_only=false
    local output_file=""
    local project_dir="."
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help
                exit 0
                ;;
            --version|-v)
                show_version
                exit 0
                ;;
            --debug)
                export DT_DEBUG=true
                shift
                ;;
            --interactive|-i)
                interactive=true
                shift
                ;;
            --validate)
                validate_only=true
                shift
                ;;
            --output|-o)
                output_file="$2"
                shift 2
                ;;
            --project|-p)
                project_dir="$2"
                shift 2
                ;;
            -*)
                dt_print_status "ERROR" "Unknown option: $1"
                echo ""
                show_help
                exit 1
                ;;
            *)
                if [ -z "$workflow" ]; then
                    workflow="$1"
                elif [ -z "$topic" ]; then
                    topic="$1"
                else
                    dt_print_status "ERROR" "Unexpected argument: $1"
                    exit 1
                fi
                shift
                ;;
        esac
    done
    
    # Validate required arguments (L1 Validation - Research Finding: REQ-IO-1)
    if [ -z "$workflow" ]; then
        dt_print_status "ERROR" "Error: Workflow type is required"
        echo ""
        echo "ðŸ’¡ Suggestion: Usage: $SCRIPT_NAME <workflow> <topic> --interactive"
        echo ""
        echo "Available workflows:"
        echo "  explore   - Start an exploration"
        echo "  research  - Conduct research (requires --from-explore)"
        echo "  decision  - Make decisions (requires --from-research)"
        echo ""
        echo "Example: $SCRIPT_NAME explore my-feature --interactive"
        exit 1
    fi
    
    if [ -z "$topic" ]; then
        dt_print_status "ERROR" "Error: Topic is required"
        echo ""
        echo "ðŸ’¡ Suggestion: Usage: $SCRIPT_NAME $workflow <topic> --interactive"
        echo ""
        echo "Example: $SCRIPT_NAME $workflow my-feature --interactive"
        exit 1
    fi
    
    # Validate workflow type
    case "$workflow" in
        explore|research|decision)
            # Valid workflows
            ;;
        *)
            dt_print_status "ERROR" "Error: Unknown workflow: $workflow"
            echo ""
            echo "ðŸ’¡ Suggestion: Available workflows: explore, research, decision"
            echo ""
            echo "Example: $SCRIPT_NAME explore $topic --interactive"
            exit 1
            ;;
    esac
    
    # --validate mode: Check inputs only (Research Finding: REQ-IO-5)
    if [ "$validate_only" = true ]; then
        echo "ðŸ” Validating inputs for: $workflow $topic"
        echo ""
        
        # L1: Existence checks
        echo "L1 Validation (Existence - Hard Fail):"
        if validate_inputs "$workflow" "$topic" "$project_dir" "L1" "false"; then
            dt_print_status "SUCCESS" "L1 checks passed"
        else
            dt_print_status "ERROR" "L1 validation failed"
            exit 1
        fi
        echo ""
        
        # L2: Structure checks
        echo "L2 Validation (Structure - Warn):"
        validate_inputs "$workflow" "$topic" "$project_dir" "L2" "false" || true
        echo ""
        
        # L3: Content checks
        echo "L3 Validation (Content - Warn):"
        validate_inputs "$workflow" "$topic" "$project_dir" "L3" "false" || true
        echo ""
        
        dt_print_status "SUCCESS" "Validation complete"
        exit 0
    fi
    
    # Phase 1: Interactive mode required
    if [ "$interactive" != true ]; then
        dt_print_status "ERROR" "Error: Phase 1 requires --interactive mode"
        echo ""
        echo "ðŸ’¡ Suggestion: Usage: $SCRIPT_NAME $workflow $topic --interactive"
        echo ""
        echo "Phase 1 (current): Script outputs context + structure for manual AI fill"
        echo "Phase 3 (future):  Script will invoke AI directly"
        exit 1
    fi
    
    # L1 Validation: Check required inputs exist (Research Finding: REQ-IO-1)
    validate_inputs "$workflow" "$topic" "$project_dir" "L1"
    
    # L2/L3 Validation: Warn on structure/content issues (non-blocking)
    validate_inputs "$workflow" "$topic" "$project_dir" "L2"
    validate_inputs "$workflow" "$topic" "$project_dir" "L3"
    
    # Generate output
    if [ -n "$output_file" ]; then
        # Validate output directory exists (handle invalid paths)
        local output_dir
        output_dir=$(dirname "$output_file")
        if [ ! -d "$output_dir" ]; then
            dt_print_status "ERROR" "Error: Output directory does not exist: $output_dir"
            echo ""
            echo "ðŸ’¡ Suggestion: Create the directory first or use a valid path"
            exit 1
        fi
        
        # Attempt to write output file (capture both stdout and stderr)
        # Use a temp file first to catch write errors before finalizing
        local temp_output
        temp_output=$(mktemp)
        if ! output_for_ai "$workflow" "$topic" "$project_dir" > "$temp_output" 2>&1; then
            rm -f "$temp_output"
            dt_print_status "ERROR" "Error: Failed to generate output"
            echo ""
            echo "ðŸ’¡ Suggestion: Check workflow inputs and try again"
            exit 1
        fi
        
        # Move temp file to final location (catches permission errors)
        if ! mv "$temp_output" "$output_file" 2>/dev/null; then
            rm -f "$temp_output"
            dt_print_status "ERROR" "Error: Failed to write output file: $output_file"
            echo ""
            echo "ðŸ’¡ Suggestion: Check file permissions and directory access"
            exit 1
        fi
        
        dt_print_status "SUCCESS" "Output saved to: $output_file"
        echo ""
        echo "ðŸ’¡ Next: Open $output_file in Cursor and let AI fill the structure"
    else
        output_for_ai "$workflow" "$topic" "$project_dir"
    fi
}

# Only execute main if script is run directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
