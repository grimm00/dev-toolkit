---
alwaysApply: true
---

# Script Standards

**Purpose:** Bash script quality, testing, and portability standards for dev-toolkit  
**Last Updated:** 2026-01-09  
**Status:** ‚úÖ Active

---

## üìã Quick Links

- **[Main Rules](main.mdc)** - Core project rules and standards
- **[Workflow Rules](workflow.mdc)** - Development workflow and processes

---

## üîß Bash Script Standards

### Shebang and Strict Mode

**ALWAYS start scripts with:**

```bash
#!/usr/bin/env bash

# Script description
# Usage: script.sh [arguments]

set -euo pipefail
```

**Strict mode explained:**
- `set -e` - Exit on error
- `set -u` - Error on undefined variables
- `set -o pipefail` - Pipe fails if any command fails

### Script Structure

**Follow this standard structure:**

```bash
#!/usr/bin/env bash

# ============================================================================
# SCRIPT NAME - Brief Description
# Usage: script.sh [arguments] [options]
# ============================================================================

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

VERSION="1.0.0"
SCRIPT_NAME=$(basename "$0")
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ============================================================================
# FUNCTIONS
# ============================================================================

show_help() {
    cat << EOF
Usage: $SCRIPT_NAME [arguments] [options]

Description here.

Arguments:
    ARG1        Description of argument 1

Options:
    --help      Show this help message
    --version   Show version information
    --debug     Enable debug output

Examples:
    $SCRIPT_NAME 123
    $SCRIPT_NAME 123 --output file.md

EOF
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

main() {
    # Parse arguments
    # Execute logic
}

main "$@"
```

---

## üß™ Testing Requirements

### CRITICAL: NEVER COMMIT WITHOUT TESTING

- **MANDATORY**: Test ALL script changes before committing
- **MANDATORY**: Verify scripts work in different project contexts
- **MANDATORY**: Check for portability issues
- **NEVER**: Commit changes with hardcoded project-specific values

### Test Framework

**Use Bats (Bash Automated Testing System):**

```bash
# Install
brew install bats-core  # macOS
apt install bats        # Ubuntu

# Run tests
bats tests/unit/
bats tests/integration/
```

### Test File Structure

```bash
#!/usr/bin/env bats

# Test file for dt-command
# Location: tests/unit/test-dt-command.bats

load '../helpers/setup'
load '../helpers/assertions'
load '../helpers/mocks'

setup() {
    # Setup before each test
}

teardown() {
    # Cleanup after each test
}

@test "dt-command shows help with --help" {
    run "$DT_COMMAND" --help
    [ "$status" -eq 0 ]
    [[ "$output" =~ "Usage:" ]]
}

@test "dt-command validates numeric input" {
    run "$DT_COMMAND" "not-a-number"
    [ "$status" -eq 1 ]
    [[ "$output" =~ "must be numeric" ]]
}
```

### Testing Commands

```bash
# Test script syntax (no execution)
bash -n script.sh

# Run unit tests
bats tests/unit/

# Run integration tests
bats tests/integration/

# Run all tests
./scripts/test.sh

# Run specific test file
bats tests/unit/test-dt-review.bats

# Verbose output
bats --verbose-run tests/unit/
```

---

## üåç Portability Requirements

### Never Hardcode Project-Specific Values

**‚ùå BAD:**

```bash
PROJECT_NAME="dev-toolkit"
PROJECT_OWNER="grimm00"
REPO_PATH="/Users/cdwilson/Projects/dev-toolkit"
```

**‚úÖ GOOD:**

```bash
# Auto-detect from git
PROJECT_REPO=$(gh repo view --json nameWithOwner --jq '.nameWithOwner' 2>/dev/null || echo "")
PROJECT_NAME=$(basename "$PROJECT_REPO")
PROJECT_OWNER=$(dirname "$PROJECT_REPO")

# Or from git remote
PROJECT_REPO=$(git remote get-url origin | sed -E 's/.*[:/]([^/]+\/[^/]+)(\.git)?$/\1/')
```

### Path Management

**Always use:**
- `$HOME` instead of `~`
- Absolute paths in critical operations
- Auto-detection for repository info

**Support multiple installation locations:**

```bash
# Detect toolkit root
if [ -n "${DT_ROOT:-}" ]; then
    TOOLKIT_ROOT="$DT_ROOT"
elif [ -f "$HOME/.dev-toolkit/bin/dt-review" ]; then
    TOOLKIT_ROOT="$HOME/.dev-toolkit"
elif [ -f "$(dirname "${BASH_SOURCE[0]}")/../lib/core/github-utils.sh" ]; then
    TOOLKIT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
else
    echo "‚ùå Error: Cannot locate dev-toolkit installation"
    exit 1
fi
```

### Dependency Checking

**Check required dependencies:**

```bash
check_dependencies() {
    local missing=()
    
    for cmd in git gh; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo "‚ùå Missing required dependencies: ${missing[*]}"
        echo "üí° Please install:"
        for dep in "${missing[@]}"; do
            case $dep in
                "git") echo "   - Git: https://git-scm.com/" ;;
                "gh") echo "   - GitHub CLI: https://cli.github.com/" ;;
            esac
        done
        exit 1
    fi
}
```

### Optional Dependencies

**Handle gracefully:**

```bash
# Check for optional jq
if command -v jq >/dev/null 2>&1; then
    # Use jq for faster JSON processing
    result=$(echo "$json" | jq '.field')
else
    # Fallback to grep/sed
    result=$(echo "$json" | grep -o '"field":"[^"]*"' | cut -d'"' -f4)
fi
```

---

## üìù Documentation Standards

### Help Text

**Every command MUST have:**

```bash
show_help() {
    cat << EOF
Usage: $SCRIPT_NAME [PR_NUMBER] [OPTIONS]

Brief description of what the command does.

Arguments:
    PR_NUMBER       Pull request number to process

Options:
    --output FILE   Save output to file
    --no-details    Omit verbose details
    --rich-details  Include structured details
    --debug         Enable debug output
    --help          Show this help message
    --version       Show version information

Examples:
    $SCRIPT_NAME 123
    $SCRIPT_NAME 123 --output review.md
    $SCRIPT_NAME 123 --rich-details

EOF
}
```

### Version Info

```bash
show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}
```

### Inline Comments

**Comment complex logic:**

```bash
# Extract repository from various git URL formats:
# - SSH: git@github.com:owner/repo.git
# - HTTPS: https://github.com/owner/repo.git
PROJECT_REPO=$(echo "$remote_url" | sed -E 's/.*[:/]([^/]+\/[^/]+)(\.git)?$/\1/' | sed 's/\.git$//')
```

---

## ‚ö†Ô∏è Error Handling

### Clear Error Messages

```bash
if [ -z "$PR_NUMBER" ]; then
    echo "‚ùå Error: PR number is required"
    echo ""
    echo "Usage: $SCRIPT_NAME <PR_NUMBER>"
    echo ""
    echo "üí° Example: $SCRIPT_NAME 123"
    exit 1
fi
```

### Validate Input

```bash
# Validate PR number is numeric
if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
    echo "‚ùå Error: PR number must be numeric (got: $PR_NUMBER)"
    echo ""
    echo "Usage: $SCRIPT_NAME <PR_NUMBER>"
    exit 1
fi
```

### Graceful Degradation

```bash
# Try primary method, fallback if unavailable
if gh auth status &>/dev/null; then
    # Use GitHub CLI
    result=$(gh api repos/$REPO/pulls/$PR)
else
    echo "‚ö†Ô∏è GitHub CLI not authenticated"
    echo "üí° Run: gh auth login"
    # Attempt fallback or exit gracefully
fi
```

---

## üé® Output Formatting

### Color Codes

```bash
# Only use colors if terminal supports it
if [[ -t 1 ]] && command -v tput >/dev/null 2>&1; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    NC='\033[0m'  # No Color
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' NC=''
fi
```

### Status Functions

```bash
print_status() {
    local type=$1
    local message=$2
    case $type in
        "ERROR")   echo -e "${RED}‚ùå $message${NC}" ;;
        "WARNING") echo -e "${YELLOW}‚ö†Ô∏è  $message${NC}" ;;
        "SUCCESS") echo -e "${GREEN}‚úÖ $message${NC}" ;;
        "INFO")    echo -e "${BLUE}‚ÑπÔ∏è  $message${NC}" ;;
    esac
}
```

---

## üîç Debugging

### Debug Mode

```bash
DEBUG=${DEBUG:-false}

debug() {
    if [ "$DEBUG" = true ]; then
        echo -e "${CYAN}[DEBUG] $*${NC}" >&2
    fi
}

# Enable with --debug flag or DEBUG=true
if [[ "${1:-}" == "--debug" ]]; then
    DEBUG=true
    shift
fi

# Usage
debug "Processing PR #$PR_NUMBER"
debug "Repository: $PROJECT_REPO"
```

---

## üîó Related

- **Main Rules:** [main.mdc](main.mdc) - Core project rules
- **Workflow Rules:** [workflow.mdc](workflow.mdc) - Development workflow
- **Testing Docs:** `docs/TESTING.md` - Test documentation
- **Troubleshooting:** `docs/troubleshooting/` - Common issues

---

**Last Updated:** 2026-01-09  
**Status:** ‚úÖ Active
